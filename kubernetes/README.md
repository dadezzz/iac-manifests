# Kubernetes

## Tools needed for kubernetes

- age (generate key for sops): [https://github.com/FiloSottile/age]
- helm
- kubectl
- kustomize
- sops (secret encryption): [https://github.com/getsops/sop]

## Secrets

Secrets are encrypted using sops. If you want to use them you will have to
generate a secret key and generate new ones.

## Naming conventions

- Each app's manifests are stored in a folder with the name of the app's
  namespace.
- Inside the folder we create subfolders for each type of resource and those
  subfolders contain yaml files with the name of the resource that they define.
- The only exception is the namespace.yaml file that defines the namespace and
  is unique per folder.
- All yaml files use the `.yaml` extension and not `.yml`.
- Persistent volumes storing data that needs to be backed up must have their
  name ending with `-data`, otherwise choose an appropriate suffix like `-cache`
  for cache persistent volumes.

## Generated resources

Configmaps and secrets are automatically generated by kustomize. Their sources
are stored inside the `generated` subdirectory of each app.

## Bootstrap

```sh
# 1. Get first node running.
# 2. Install cilium. (values are taken from the helmrelease file)
helm install -n cilium cilium cilium/cilium --values v.yaml
# 3. Apply coredns.
# 4. Apply fluxcd.
# 5. Apply blocky.
# 6. Apply cert-manager.
# 7. Apply cilium.
# 8. Repeat last steps until all circular dependencies are resolved.
```
